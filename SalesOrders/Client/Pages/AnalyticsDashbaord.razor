@page "/analytics"
@using SalesOrders.Client.Service.OrdersService
@inject IOrderService Orders
@inject IJSRuntime JS
@inject NavigationManager Navigation

<div id="chart"></div>
<div id="LineChart"></div>

@code {
    private OrderTypeStatsVM orderTypeStats;
    private OrderHeaderStatsVM orderHeaderStats;

    //Issues to do research on: 
    //Blazor’s client-side navigation not triggering a full page reload. - causing js to not render even though it is available. 

    //Immplemented a temp solution - when navigating to the page trigger a reload of the page ensuring all js is invoked correctly.
    protected override async Task OnInitializedAsync()
    {
        // Check if the URL has been reloaded by looking for the "reloaded=true" parameter
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var hasReloaded = uri.Query.Contains("reloaded=true");

        if (!hasReloaded)
        {
            // Add a query parameter to the URL and reload the page
            var newUri = $"{Navigation.Uri}?reloaded=true";
            Navigation.NavigateTo(newUri, forceLoad: true); // Force full reload with query param
        }
        else
        {
            // Perform the normal operations after page reload
            var response = await Orders.GetOrderTypeStats();
            if (response != null)
            {
                orderTypeStats = response;

                // Prepare data for the chart
                var chartData = new
                {
                    series = orderTypeStats.orderTypes.Select(ot => ot.Values.First()).ToArray(),
                    labels = orderTypeStats.orderTypes.Select(ot => ot.Keys.First()).ToArray()
                };

                // Pass the data to the JavaScript function
                await JS.InvokeVoidAsync("renderChart", chartData);
            }

            var lineChartResponse = await Orders.GetHeaderStats();
            if (lineChartResponse != null)
            {
                orderHeaderStats = lineChartResponse;

                //prepare data for line chart
                var chartData = new
                {
                    series = new[]
                     {
                        new
                        {
                            name = "Order Count",
                            data = orderHeaderStats.orderHeaders
                                .GroupBy(oh => oh.Values.First()) // Group by createdDate
                                .Select(g => g.Count()) // Count the number of orders per date
                                .ToArray() // Convert to array
                        }
                    },
                    categories = orderHeaderStats.orderHeaders.Select(oh => oh.Values.First().ToString("yyyy-MM-dd")).ToArray() // created dates as categories
                };

                // Pass the data to the JavaScript function
                await JS.InvokeVoidAsync("lineChart", chartData);
            }
        } 
    }
}
