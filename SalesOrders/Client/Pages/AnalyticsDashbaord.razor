@page "/analytics"
@using SalesOrders.Client.Service.OrdersService
@inject IOrderService Orders
@inject IJSRuntime JS
@inject NavigationManager Navigation
@attribute [Authorize]

<div class="container">
    <div class="row">
        <!-- Pie Chart -->
        <div class="col-md-6">
            <div id="chart"></div> <!-- Pie Chart div -->
        </div>

        <!-- Cards -->
        <div class="col-md-6">
            <div class="row">
                <div class="col-md-6">
                    <mud-card class="card" style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        <mud-card-content class="text-center">
                            <!-- Card content 1 -->
                            <h4>Number of orders</h4>
                            <p>@(orderHeaderStats != null ? orderHeaderStats.orderCount : "Loading...")</p>
                        </mud-card-content>
                    </mud-card>
                </div>

                <div class="col-md-6">
                    <mud-card class="card" style="height: 100%; display: flex; align-items: center; justify-content: center;">
                        <mud-card-content>
                            <!-- Card content 2 -->
                            <h4>Number of customers</h4>
                            <p>@(orderHeaderStats != null ? orderHeaderStats.customerCount : "Loading...")</p>
                        </mud-card-content>
                    </mud-card>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="LineChart"></div> <!-- Line chart div -->


@code {
    private OrderTypeStatsVM orderTypeStats;
    private OrderHeaderStatsVM orderHeaderStats;

    //Issues to do research on: 
    //Blazor’s client-side navigation not triggering a full page reload. - causing js to not render even though it is available. 

    //Immplemented a temp solution - when navigating to the page trigger a reload of the page ensuring all js is invoked correctly.
    protected override async Task OnInitializedAsync()
    {
        // Check if the URL has been reloaded by looking for the "reloaded=true" parameter
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var hasReloaded = uri.Query.Contains("reloaded=true");

        if (!hasReloaded)
        {
            // Add a query parameter to the URL and reload the page
            var newUri = $"{Navigation.Uri}?reloaded=true";
            Navigation.NavigateTo(newUri, forceLoad: true); // Force full reload with query param
        }
        else
        {
            // Perform the normal operations after page reload
            var response = await Orders.GetOrderTypeStats();
            if (response != null)
            {
                orderTypeStats = response;

                // Prepare data for the chart
                var chartData = new
                {
                    series = orderTypeStats.orderTypes.Select(ot => ot.Values.First()).ToArray(),
                    labels = orderTypeStats.orderTypes.Select(ot => ot.Keys.First()).ToArray()
                };

                // Pass the data to the JavaScript function
                await JS.InvokeVoidAsync("renderChart", chartData);
            }

            var lineChartResponse = await Orders.GetHeaderStats();
            if (lineChartResponse != null)
            {
                orderHeaderStats = lineChartResponse;

                // Prepare data for line chart
                var chartData = new
                {
                    series = new[]
                    {
                        new
                        {
                            name = "Order Count",
                            data = orderHeaderStats.orderHeaders
                                .GroupBy(oh => oh.Values.First().Date) // Group by the Date (ignoring time)
                                .Select(g => g.Count()) // Count the number of orders per date
                                .ToArray() // Convert to array
                        }
                    },
                    categories = orderHeaderStats.orderHeaders
                        .GroupBy(oh => oh.Values.First().Date) // Group by date again to get distinct dates
                        .Select(g => g.Key.ToString("yyyy-MM-dd")) // Convert each date to string for the categories
                        .ToArray() // Convert to array
                };

                // Pass the data to the JavaScript function
                await JS.InvokeVoidAsync("lineChart", chartData);
            }
        } 
    }
}
